<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Recarga</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
        #reader { width: 300px; margin: auto; }
        input, button { margin-top: 10px; padding: 10px; width: 80%; font-size: 16px; }
        button { background-color: #28a745; color: white; border: none; cursor: pointer; }
        button:disabled { background-color: gray; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>Registro de Recarga de Agua</h1>
    <p><strong>Dispenser:</strong> <span id="dispenserId">Escanea un QR</span></p>

    <label for="usuarioInput">Tu Nombre:</label>
    <input type="text" id="usuarioInput" name="usuario" placeholder="Ingresa tu nombre" autocomplete="name">

    <button id="registrar" disabled>Registrar Recarga</button>

    <h2>Escanea el C√≥digo QR</h2>
    <div id="reader"></div>
    <p id="mensaje"></p>

    <!-- üöÄ Se mueve el script al final del <body> -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            console.log("üöÄ P√°gina cargada completamente");

            // ‚úÖ Reemplaza con la URL de tu Google Apps Script
            const sheetAPI = "https://script.google.com/macros/s/AKfycbz4UMwCBTLJyAgZt_dggVfS0DMBbI2jCvUfQFJ31NOL69S8wWDvkfnN4sfu3cLLdLcS/exec"; 

            let dispenserId = "";
            const registrarBtn = document.getElementById("registrar");
            const usuarioInput = document.getElementById("usuarioInput");

            console.log("üìå Elementos encontrados:", registrarBtn, usuarioInput);

            function verificarBoton() {
                console.log("üîÑ Verificando si el bot√≥n debe estar habilitado...");
                if (usuarioInput.value.trim() !== "" && dispenserId !== "") {
                    registrarBtn.disabled = false;
                    console.log("‚úÖ Bot√≥n habilitado");
                } else {
                    registrarBtn.disabled = true;
                    console.log("‚ùå Bot√≥n deshabilitado");
                }
            }

            usuarioInput.addEventListener("input", verificarBoton);

            registrarBtn.addEventListener("click", async () => {
                console.log("üõ† Bot√≥n 'Registrar Recarga' fue presionado");

                let usuario = usuarioInput.value.trim();
                if (!usuario) {
                    alert("‚ö†Ô∏è Por favor, ingresa tu nombre.");
                    return;
                }

                const requestData = { dispenser: dispenserId, usuario };
                console.log("üì§ Enviando datos:", requestData);

                try {
                    const response = await fetch(sheetAPI, {
                        method: "POST",
                        body: JSON.stringify(requestData),
                        headers: { "Content-Type": "application/json" }
                    });

                    const responseData = await response.text();
                    console.log("‚úÖ Respuesta del servidor:", responseData);
                    document.getElementById("mensaje").innerText = responseData;
                } catch (error) {
                    console.error("‚ùå Error al enviar datos:", error);
                    document.getElementById("mensaje").innerText = "Error al registrar. Intenta de nuevo.";
                }
            });

            // ‚úÖ Escanear c√≥digo QR con la c√°mara
            function onScanSuccess(qrCodeMessage) {
                dispenserId = qrCodeMessage;
                document.getElementById("dispenserId").innerText = dispenserId;
                verificarBoton();
                console.log("‚úÖ C√≥digo QR escaneado:", dispenserId);
            }

            function onScanError(errorMessage) {
                console.warn("‚ö†Ô∏è Error escaneando QR:", errorMessage);
            }

            let html5QrcodeScanner = new Html5QrcodeScanner(
                "reader", { fps: 10, qrbox: 250 });
            html5QrcodeScanner.render(onScanSuccess, onScanError);
        });
    </script>
</body>
</html>
